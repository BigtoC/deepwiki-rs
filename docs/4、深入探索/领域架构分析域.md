# **领域架构分析域技术实现文档**

---

## **1. 概述**

**领域架构分析域**（Domain Architecture Analysis Domain）是 `deepwiki-rs` 项目中的核心业务模块之一，负责从高层次识别和定义目标代码库的领域结构、系统边界与关键工作流。该模块基于 C4 架构模型理念，采用多智能体协作机制，通过自顶向下的分层分析方法，将原始代码转化为具备功能价值导向的领域划分报告。

本模块位于系统“研究阶段”（Research Phase），承接预处理阶段输出的代码洞察与结构信息，为后续文档合成阶段提供语义丰富的上下文输入，是连接代码理解与文档生成的关键桥梁。

> ✅ **定位说明**：  
> 该模块不关注具体语法解析或函数级细节，而是聚焦于**系统级抽象能力**，旨在回答：“这个系统由哪些高阶功能领域构成？它们如何协作？整体架构呈现何种模式？”

---

## **2. 核心职责与目标**

### **2.1 主要职责**
| 职责 | 描述 |
|------|------|
| **系统上下文建模** | 确定项目类型、用户角色、外部依赖及系统边界，建立 C1 层级视图 |
| **领域模块识别** | 基于功能价值而非技术实现，识别并划分高层次业务领域及其子模块 |
| **架构模式分析** | 提取整体软件架构特征，生成 Mermaid 可视化描述 |
| **核心流程梳理** | 分析主干业务流程，明确执行路径与跨领域交互 |
| **边界接口探测** | 识别 CLI、API、配置等对外暴露的调用接口 |
| **关键模块深入洞察** | 对重点领域进行微观层面的技术方案剖析 |

### **2.2 设计目标**
- ✅ **功能导向**：强调“做什么”而非“怎么做”，避免陷入技术栈细节
- ✅ **结构化输出**：所有分析结果均以 JSON Schema 定义的结构化数据返回
- ✅ **可追溯性**：支持从最终文档反向追踪至原始代码文件
- ✅ **置信度评估**：每个分析结果附带置信评分，辅助用户判断可靠性

---

## **3. 模块组成与组件详解**

领域架构分析域由多个遵循统一接口的智能体（Agent）构成，各组件按 C4 模型层级组织，形成清晰的分析流水线。

### **3.1 组件概览**

| 组件名称 | 文件路径 | 执行顺序 | 输出类型 | LLM 调用模式 |
|--------|--------|---------|----------|-------------|
| `SystemContextResearcher` | `research/agents/system_context_researcher.rs` | 第一阶段（C1） | `SystemContextReport` | `Extract` |
| `DomainModulesDetector` | `research/agents/domain_modules_detector.rs` | 第二阶段（C2） | `DomainModulesReport` | `Extract` |
| `ArchitectureResearcher` | `research/agents/architecture_researcher.rs` | 第二阶段（C2） | `String` (Mermaid) | `PromptWithTools` |
| `WorkflowResearcher` | `research/agents/workflow_researcher.rs` | 第二阶段（C2） | `WorkflowReport` | `Extract` |
| `KeyModulesInsight` | `research/agents/key_modules_insight.rs` | 第三阶段（C3/C4） | `Vec<KeyModuleReport>` | `Extract` |
| `BoundaryAnalyzer` | `research/agents/boundary_analyzer.rs` | 第三阶段（C3/C4） | `BoundaryAnalysisReport` | `Extract` |

---

### **3.2 关键组件详细说明**

#### **(1) SystemContextResearcher —— 系统上下文研究员**

- **作用**：完成 C1 系统上下文建模，确定项目的宏观定位。
- **输入来源**：
  - `PROJECT_STRUCTURE`：项目目录结构
  - `CODE_INSIGHTS`：前50个最重要的代码洞察
  - `README_CONTENT`（可选）：人工编写的说明文档
- **输出内容**：
  ```rust
  struct SystemContextReport {
      project_name: String,
      project_type: ProjectType, // 如 BackendService, CLITool 等
      target_users: Vec<UserPersona>,
      external_systems: Vec<ExternalSystem>,
      system_boundary: SystemBoundary,
      confidence_score: f64,
  }
  ```
- **提示词策略**：
  - 使用 `LLMCallMode::Extract` 强制返回结构化 JSON
  - 强调“谁在使用它？与哪些外部系统交互？系统边界在哪里？”
- **重要性**：作为后续所有分析的基础输入，其准确性直接影响整体质量。

---

#### **(2) DomainModulesDetector —— 领域模块探测器（核心）**

- **作用**：执行领域驱动设计中的战略建模，识别系统的高阶功能领域。
- **输入来源**：
  - `ResearchResult("SystemContextResearcher")`
  - `DEPENDENCY_ANALYSIS`：模块间依赖关系图谱
  - `CODE_INSIGHTS`：核心文件的功能摘要
  - `PROJECT_STRUCTURE`（可选）
- **输出内容**：
  ```rust
  struct DomainModulesReport {
      domain_modules: Vec<DomainModule>,        // 高层次领域列表
      domain_relations: Vec<DomainRelation>,    // 领域间依赖/调用关系
      business_flows: Vec<BusinessFlow>,        // 核心执行流程
      architecture_summary: String,             // 架构特点总结
      confidence_score: f64,
  }
  ```
- **分析原则**（见 `prompt_template.closing_instruction`）：
  - 自顶向下，先领域后模块
  - 领域划分体现**功能价值**，非技术实现
  - 合理抽象，避免过度细化
  - 关注核心业务逻辑与关键依赖
- **后处理行为**：
  - 打印统计摘要：领域数量、子模块总数、关系数、置信度
  - 存储至内存作用域 `STUDIES_RESEARCH`

---

#### **(3) ArchitectureResearcher —— 架构研究员**

- **作用**：基于已识别的领域结构，生成可视化系统架构图（Mermaid 格式）。
- **输入来源**：
  - `SystemContextResearcher` 结果
  - `DomainModulesDetector` 结果
  - （可选）项目结构与依赖分析
- **输出形式**：纯文本字符串，包含 Mermaid 图表代码
  ```mermaid
  graph TD
      A[用户管理域] --> B[认证服务]
      B --> C[(数据库)]
  ```
- **调用模式**：`LLMCallMode::PromptWithTools`，允许 LLM 调用内置工具辅助推理
- **分析要求**：
  - 重点体现核心组件与交互模式
  - 符合 C4 容器视图标准
  - 支持自动布局建议

---

#### **(4) WorkflowResearcher —— 工作流研究员**

- **作用**：提取系统级主干工作流程，如“项目分析流程”、“代码构建流程”等。
- **输入来源**：
  - `SystemContextResearcher`
  - `DomainModulesDetector`
  - `CODE_INSIGHTS`
- **输出内容**：
  ```rust
  struct WorkflowReport {
      main_workflow: Workflow,
      other_important_workflows: Vec<Workflow>,
  }

  struct Workflow {
      name: String,
      description: String,
      flowchart_mermaid: String,
  }
  ```
- **视角要求**：从**功能场景**出发，描述用户或系统触发的关键路径，而非代码调用链。

---

#### **(5) KeyModulesInsight —— 关键模块洞察器**

- **作用**：对每个识别出的领域模块进行深度技术剖析，生成微观级技术文档草稿。
- **执行方式**：
  - 并发执行（受 `config.llm.max_parallels` 控制）
  - 使用 `do_parallel_with_limit` 实现并发限制
- **输入来源**：
  - `SystemContextResearcher`
  - `DomainModulesDetector`
- **内部逻辑**：
  1. 获取 `DomainModulesReport`
  2. 遍历每个 `DomainModule`，筛选其关联的 `CodeInsight`
  3. 为每个领域构造独立 Prompt，调用 LLM 进行深度分析
  4. 结果存储为 `KeyModuleReport`，含接口定义、交互方式、实现细节等
- **失败容忍**：单个领域分析失败不影响整体流程继续执行。

---

#### **(6) BoundaryAnalyzer —— 边界接口分析师**

- **作用**：识别系统对外暴露的调用接口，包括 CLI、API、配置项等。
- **输入来源**：
  - `PROJECT_STRUCTURE`
  - `DEPENDENCY_ANALYSIS`
  - `SystemContextResearcher`
- **特殊处理机制**：
  - 自定义 `provide_custom_prompt_content()` 方法注入边界相关代码
  - 使用 `filter_boundary_code_insights()` 筛选特定用途类型的代码：
    ```rust
    matches!(insight.code_dossier.code_purpose,
        CodePurpose::Entry | Api | Config | Router
    )
    ```
  - 按重要性排序，保留 Top 50
- **输出结构**：
  ```rust
  struct BoundaryAnalysisReport {
      cli_boundaries: Vec<CLIBoundary>,
      api_boundaries: Vec<APIBoundary>,
      integration_suggestions: Vec<IntegrationSuggestion>,
      confidence_score: f64,
  }
  ```
- **应用场景**：为新开发者提供快速集成指南与安全建议。

---

## **4. 数据流与执行流程**

### **4.1 执行顺序（C1 → C2 → C3/C4）**

```text
[预处理阶段]
     ↓
SystemContextResearcher  ← 输入：ProjectStructure + CodeInsights
     ↓
DomainModulesDetector    ← 输入：SystemContext + Dependencies + CodeInsights
     ↓
├─ ArchitectureResearcher ← 输入：SystemContext + DomainModules
├─ WorkflowResearcher     ← 输入：SystemContext + DomainModules + CodeInsights
└─ KeyModulesInsight      ← 输入：SystemContext + DomainModules（并发执行）
     ↓
BoundaryAnalyzer         ← 输入：ProjectStructure + Dependencies + SystemContext
```

该流程由 `ResearchOrchestrator::execute_research_pipeline()` 编排执行。

---

### **4.2 内存作用域管理**

所有研究成果统一写入 `MemoryScope::STUDIES_RESEARCH`：

| 键名（Key） | 对应 Agent | 数据类型 |
|------------|-----------|---------|
| `"SystemContextResearcher"` | `SystemContextResearcher` | `SystemContextReport` |
| `"DomainModulesDetector"`   | `DomainModulesDetector`   | `DomainModulesReport` |
| `"ArchitectureResearcher"`  | `ArchitectureResearcher`  | `String` |
| `"WorkflowResearcher"`      | `WorkflowResearcher`      | `WorkflowReport` |
| `"KeyModulesInsight"`       | `KeyModulesInsight`       | `Vec<KeyModuleReport>` |
| `"BoundaryAnalyzer"`        | `BoundaryAnalyzer`        | `BoundaryAnalysisReport` |

> 📌 **访问方式**：通过 `GeneratorContext.get_research(&agent_type)` 异步获取。

---

## **5. 技术实现机制**

### **5.1 统一 Agent 接口：`StepForwardAgent`**

所有分析智能体实现统一 trait：

```rust
#[async_trait]
pub trait StepForwardAgent: Send + Sync {
    type Output: JsonSchema + Deserialize + Serialize;

    fn agent_type(&self) -> String;
    fn memory_scope_key(&self) -> String;
    fn data_config(&self) -> AgentDataConfig;
    fn prompt_template(&self) -> PromptTemplate;

    async fn execute(&self, context: &GeneratorContext) -> Result<Self::Output>;
    fn post_process(&self, result: &Self::Output, ctx: &GeneratorContext) -> Result<()>;
}
```

此设计实现了：
- ✅ **标准化执行流程**
- ✅ **自动化数据验证**（检查必需输入是否存在）
- ✅ **统一日志与缓存管理**
- ✅ **灵活扩展性**

---

### **5.2 提示工程（Prompt Engineering）策略**

#### **通用模板结构**
```rust
PromptTemplate {
    system_prompt: "你是专业的软件架构分析师...",
    opening_instruction: "基于以下调研材料，进行高层次架构分析：",
    closing_instruction: "## 分析要求：\n- 采用自顶向下方法\n- 领域划分体现功能价值...",
    llm_call_mode: LLMCallMode::Extract,
    formatter_config: FormatterConfig { ... },
}
```

#### **格式化控制（FormatterConfig）**
| 参数 | 说明 |
|------|------|
| `code_insights_limit` | 默认取 Top 50 最重要的代码洞察 |
| `include_source_code` | 是否包含源码片段（仅 `BoundaryAnalyzer` 开启） |
| `only_directories_when_files_more_than` | 文件过多时仅显示目录树 |
| `enable_compression` | 启用智能压缩防止超长上下文 |

---

### **5.3 类型系统支撑（Types）**

关键结构体定义于 `src/generator/research/types.rs`，全部实现 `JsonSchema` 以便 LLM 结构化提取：

- `DomainModule`: 高层次业务领域
- `SubModule`: 领域内的具体实现单元
- `DomainRelation`: 领域间依赖关系（含强度评分）
- `BusinessFlow`: 核心功能流程（含步骤与入口点）

这些类型构成了领域知识的元模型，确保分析结果具备一致性和机器可读性。

---

## **6. 与其他模块的交互关系**

| 依赖方向 | 来源模块 | 交互方式 | 说明 |
|--------|--------|--------|------|
| ← | **代码智能分析域** | 读取 `PREPROCESS` 内存数据 | 获取 `CodeInsight`, `RelationshipAnalysis`, `ProjectStructure` |
| ← | **配置与状态管理域** | 注入 `GeneratorContext` | 获取 `config` 中的 LLM 设置、目标语言偏好等 |
| → | **智能文档生成域** | 写入 `STUDIES_RESEARCH` 内存 | 提供 `DomainModulesReport` 等用于文档合成 |
| ↔ | **大语言模型交互域** | 调用 `LLMClient` | 发起 `extract<T>()`, `prompt()`, `prompt_with_tools()` 请求 |

---

## **7. 总结与优势**

### **7.1 架构优势**
| 特性 | 说明 |
|------|------|
| **分层清晰** | 严格遵循 C4 模型层级，逐层递进分析 |
| **职责分离** | 每个 Agent 专注单一任务，降低复杂度 |
| **数据驱动** | 所有决策基于前期分析结果，保证一致性 |
| **可插拔设计** | 新增分析维度只需实现 `StepForwardAgent` |
| **可观测性强** | 实时打印进度、统计信息与置信度 |

### **7.2 应用价值**
- **软件架构师**：快速掌握遗留系统整体结构
- **开发工程师**：理解模块职责与调用关系
- **技术负责人**：评估项目健康度与知识沉淀水平

---

## **8. 可优化方向建议**

| 方向 | 建议 |
|------|------|
| **增强反馈闭环** | 支持用户标注修正领域划分，用于提示词迭代优化 |
| **引入静态分析规则** | 结合 AST 分析补充 LLM 判断盲区（如循环依赖检测） |
| **支持领域映射配置** | 允许用户预定义领域匹配规则（正则路径→领域名） |
| **增加因果推理能力** | 在 `WorkflowResearcher` 中引入因果链分析 |
| **性能优化** | 对 `KeyModulesInsight` 添加缓存粒度控制，避免重复分析 |

--- 

> **文档生成时间**: 2025-10-13 06:16:58 (UTC)  
> **分析依据**: `deepwiki-rs` 项目源码与调研材料综合分析  
> **作者**: 软件架构技术文档专家